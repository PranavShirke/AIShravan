<!DOCTYPE html>
<html>
<head>
    <title>Advanced Hand Gesture Recognition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
    background: linear-gradient(-45deg, #3a6186, #89253e, #5b5ea6, #434343);
    background-size: 400% 400%;
    animation: gradientMove 15s ease infinite;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
            padding: 20px;
    min-height: 100vh;
    color: #333;
}

@keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-container {
    max-width: 800px;
            width: 100%;
            margin: 0 auto;
            background-color: rgba(142, 142, 142, 0.518);
    border-radius: 20px;
            padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #3a6186;
            border: 2px solid #3a6186;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .back-btn:hover {
            background: #3a6186;
            color: white;
            transform: translateY(-2px);
        }

        .page-title {
    color: #3a3a3a;
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
}

#video-container {
    position: relative;
    width: 640px;
    max-width: 100%;
    height: 480px;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    margin: 0 auto;
    border: 5px solid #fff;
            background-color: #000;
}

        #output-canvas, #input-video {
    position: absolute;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            border-radius: 10px;
            transform: scaleX(-1);
    left: 0;
    top: 0;
}

#gesture-output {
    margin-top: 30px;
            font-size: 20px;
    font-weight: bold;
            padding: 10px 20px;
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    text-align: center;
    border-left: 5px solid #3a6186;
}

        #typed-text {
            margin-top: 20px;
            background: #fff;
            padding: 15px;
            width: 100%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.1);
    font-size: 24px;
            min-height: 50px;
            margin: 20px auto;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background-color: #5b5ea6;
    color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            #gesture-output {
                font-size: 18px;
                padding: 8px 15px;
            }

            #typed-text {
                font-size: 20px;
                padding: 10px;
            }
}
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <h1 class="page-title">ASL Gesture Recognition</h1>
            <div style="width: 100px;"></div>
        </div>

    <div id="video-container">
            <video id="input-video" autoplay playsinline></video>
            <canvas id="output-canvas"></canvas>
    </div>
        
    <div id="gesture-output">
            Detected Gesture: <span id="gesture">None</span>
        <div id="confidence">Confidence: <span id="confidence-value">0%</span></div>
        </div>

        <div id="typed-text"></div>

        <div class="action-buttons">
            <button class="action-btn" onclick="clearText()">
                <i class="fas fa-eraser"></i> Clear Text
            </button>
            <button class="action-btn" onclick="speakText()">
                <i class="fas fa-volume-up"></i> Speak Text
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script>
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const gestureSpan = document.getElementById('gesture');
        const typedTextDiv = document.getElementById('typed-text');
        const confidenceValue = document.getElementById('confidence-value');

        let typedText = '';
        let lastGesture = '';
        let stableCount = 0;
        let cooldown = false;
        let gestureConfidence = 0;

        function clearText() {
            typedText = '';
            typedTextDiv.textContent = '';
        }

        function speakText() {
            const msg = new SpeechSynthesisUtterance(typedText);
            window.speechSynthesis.speak(msg);
        }

        function goBack() {
            const referrer = document.referrer;
            if (referrer.includes('index.html')) {
                window.location.href = 'index.html';
            } else if (referrer.includes('dashboard.html')) {
                window.location.href = 'dashboard.html';
            } else {
                window.location.href = 'index.html';
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.7
                });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => await hands.send({image: videoElement}),
                    width: 640,
            height: 480,
            facingMode: 'user',
            aspectRatio: 1.3333333, // 4:3 aspect ratio
            resizeMode: 'crop-and-scale'
        });

        // Set video element dimensions explicitly
        videoElement.width = 640;
        videoElement.height = 480;
        canvasElement.width = 640;
        canvasElement.height = 480;

        // Add video constraints for better quality
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user',
                    frameRate: { ideal: 30 }
                }
            }).then(function(stream) {
                videoElement.srcObject = stream;
            }).catch(function(error) {
                console.error('Error accessing camera:', error);
            });
        }

        camera.start();

        function isExtended(landmarks, tip, pip, mcp) {
            // More precise finger extension check
            const tipY = landmarks[tip].y;
            const pipY = landmarks[pip].y;
            const mcpY = landmarks[mcp].y;
            
            // Check if the finger is extended (tip is above pip and mcp)
            return tipY < pipY && tipY < mcpY;
        }

        function isBent(landmarks, tip, pip, mcp) {
            // Check if finger is bent
            const tipY = landmarks[tip].y;
            const pipY = landmarks[pip].y;
            const mcpY = landmarks[mcp].y;
            
            return tipY > pipY && tipY > mcpY;
        }

        function recognizeGesture(landmarks) {
            // Get finger states with more precise checks
            const isThumb = isExtended(landmarks, 4, 3, 2);
            const isIndex = isExtended(landmarks, 8, 7, 5);
            const isMiddle = isExtended(landmarks, 12, 11, 9);
            const isRing = isExtended(landmarks, 16, 15, 13);
            const isPinky = isExtended(landmarks, 20, 19, 17);

            // Check for action gestures first
            if (isThumb && isPinky && !isIndex && !isMiddle && !isRing) {
                return 'Clear';
            }
            if (isThumb && isMiddle && isRing && !isIndex && !isPinky) {
                return 'Open';
            }

            // ASL letters with more specific checks
            if (isThumb && !isIndex && !isMiddle && !isRing && !isPinky) return 'A';
            if (!isThumb && isIndex && isMiddle && isRing && isPinky) return 'B';
            if (isThumb && isIndex && !isMiddle && isRing && !isPinky) return 'C';
            if (!isThumb && isIndex && !isMiddle && !isRing && !isPinky) return 'D';
            if (!isThumb && !isIndex && !isMiddle && !isRing && !isPinky) return 'E';
            if (isThumb && !isIndex && isMiddle && !isRing && isPinky) return 'F';
            if (isThumb && isIndex && isMiddle && !isRing && isPinky) return 'G';
            if (isIndex && isMiddle && !isRing && !isPinky && !isThumb) return 'H';
            if (isThumb && !isIndex && isMiddle && !isRing && !isPinky) return 'I';
            if (isPinky && !isThumb && !isIndex && !isMiddle && !isRing) return 'J';
            if (!isThumb && isIndex && !isMiddle && isRing && !isPinky) return 'K';
            if (isThumb && isIndex && !isMiddle && !isRing && !isPinky) return 'L';
            if (isThumb && !isIndex && !isMiddle && isRing && !isPinky) return 'M';
            if (isThumb && isIndex && !isMiddle && !isRing && !isPinky) return 'N';
            if (isThumb && !isIndex && isMiddle && isRing && !isPinky) return 'O';
            if (isThumb && isIndex && !isMiddle && !isRing && isPinky) return 'P';
            if (isThumb && isMiddle && !isIndex && !isRing && !isPinky) return 'Q';
            if (isThumb && isIndex && isMiddle && !isRing && !isPinky) return 'R';
            if (isThumb && !isIndex && !isMiddle && !isRing && !isPinky) return 'S';
            if (isThumb && isIndex && !isMiddle && !isRing && !isPinky) return 'T';
            if (isMiddle && isIndex && !isRing && !isPinky && !isThumb) return 'U';
            if (isIndex && isMiddle && !isRing && !isPinky && !isThumb) return 'V';
            if (isThumb && isIndex && isMiddle && !isRing && !isPinky) return 'W';
            if (isIndex && !isMiddle && !isRing && !isPinky && !isThumb) return 'X';
            if (isIndex && !isMiddle && !isRing && isPinky && !isThumb) return 'Y';
            if (isThumb && isIndex && isMiddle && isRing && !isPinky) return 'Z';

            return 'Unknown';
        }

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1});

                const gesture = recognizeGesture(landmarks);
                gestureSpan.textContent = gesture;

                if (!cooldown && gesture === lastGesture) {
                    stableCount++;
                    gestureConfidence = Math.min(100, (stableCount / 8) * 100); // Increased stability threshold
                    confidenceValue.textContent = `${Math.round(gestureConfidence)}%`;

                    if (stableCount >= 8) { // Increased stability requirement
                        handleGesture(gesture);
                        cooldown = true;
                        setTimeout(() => cooldown = false, 1500);
                        stableCount = 0;
                    }
                } else {
                    stableCount = 0;
                    gestureConfidence = 0;
                    confidenceValue.textContent = '0%';
                }
                lastGesture = gesture;
                } else {
                gestureSpan.textContent = 'No hand detected';
                confidenceValue.textContent = '0%';
            }
            canvasCtx.restore();
        }

        function handleGesture(gesture) {
            if (gesture === 'Open') {
                typedText += ' ';
            } else if (gesture === 'Clear') {
                clearText();
            } else if (gesture.length === 1 && /[A-Z]/.test(gesture)) {
                typedText += gesture;
            }
            typedTextDiv.textContent = typedText;
        }
    </script>
</body>
</html>